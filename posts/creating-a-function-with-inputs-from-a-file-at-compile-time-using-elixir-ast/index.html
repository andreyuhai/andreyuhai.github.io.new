<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Creating a function with inputs from a file at compile time using Elixir AST" /><meta property="og:locale" content="en" /><meta name="description" content="Let me fill you in on what the problem I was trying to solve was, then we can get to how I‚Äôve solved the problem by creating a function with inputs from a ‚Äúdefaults‚Äù file at compile time using Elixir‚Äôs Abstract Syntax Tree (AST)." /><meta property="og:description" content="Let me fill you in on what the problem I was trying to solve was, then we can get to how I‚Äôve solved the problem by creating a function with inputs from a ‚Äúdefaults‚Äù file at compile time using Elixir‚Äôs Abstract Syntax Tree (AST)." /><link rel="canonical" href="https://blog.burakaymakci.com/posts/creating-a-function-with-inputs-from-a-file-at-compile-time-using-elixir-ast/" /><meta property="og:url" content="https://blog.burakaymakci.com/posts/creating-a-function-with-inputs-from-a-file-at-compile-time-using-elixir-ast/" /><meta property="og:site_name" content="Burak Kaymakci" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-27T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Creating a function with inputs from a file at compile time using Elixir AST" /><meta name="twitter:site" content="@andreyuhai" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-06-28T02:09:18+02:00","datePublished":"2022-06-27T00:00:00+02:00","description":"Let me fill you in on what the problem I was trying to solve was, then we can get to how I‚Äôve solved the problem by creating a function with inputs from a ‚Äúdefaults‚Äù file at compile time using Elixir‚Äôs Abstract Syntax Tree (AST).","headline":"Creating a function with inputs from a file at compile time using Elixir AST","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.burakaymakci.com/posts/creating-a-function-with-inputs-from-a-file-at-compile-time-using-elixir-ast/"},"url":"https://blog.burakaymakci.com/posts/creating-a-function-with-inputs-from-a-file-at-compile-time-using-elixir-ast/"}</script><title>Creating a function with inputs from a file at compile time using Elixir AST | Burak Kaymakci</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Burak Kaymakci"><meta name="application-name" content="Burak Kaymakci"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG ‚Ä∫ <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.updateMermaid(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Burak Kaymakci</a></div><div class="site-subtitle font-italic">A life-long student who loves programming languages and the ones we speak.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://www.linkedin.com/in/burakaymakci/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://github.com/andreyuhai" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://stackoverflow.com/users/4796762/burak-kaymakci" aria-label="stack-overflow" target="_blank" rel="noopener"> <i class="fab fa-stack-overflow"></i> </a> <a href="https://twitter.com/andreyuhai" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Creating a function with inputs from a file at compile time using Elixir AST</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Creating a function with inputs from a file at compile time using Elixir AST</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/andreyuhai">Burak Kaymakci</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-06-27 00:00:00 +0200" data-toggle="tooltip" data-placement="bottom" title="Mon, Jun 27, 2022, 12:00 AM +0200" >Jun 27</em> </span> <span> Updated <em class="timeago" date="2022-06-28 02:09:18 +0200 " data-toggle="tooltip" data-placement="bottom" title="Tue, Jun 28, 2022, 2:09 AM +0200" >Jun 28</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="968 words"> <em>5 min</em> read</span></div></div></div><div class="post-content"><p>Let me fill you in on what the problem I was trying to solve was, then we can get to how I‚Äôve solved the problem by creating a function with inputs from a ‚Äúdefaults‚Äù file at compile time using Elixir‚Äôs Abstract Syntax Tree (AST).</p><p>We have a CSV file that has some defaults for our business logic, the file barely changes and is not huge. The content of the file is transformed into a list of tuples using a script and the script is included in one of the modules as comments. Using this script (in an <code class="language-plaintext highlighter-rouge">iex</code> shell), you would get the output, which is a list of tuples, and paste it into appropriate function body, which would be used at runtime. Whenever the CSV file changes you would do the same things described above.</p><p>So the script looks something like this</p><div class="language-elixir highlighter-rouge"><div class="code-header"> <span label-text="Elixir"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c1"># example CSV just in case you want to run this script.</span>
<span class="c1"># Just copy &amp; paste the values below into some CSV file.</span>
<span class="c1"># </span>
<span class="c1"># service_name,base_price,duration</span>
<span class="c1"># Haircut,50,30</span>
<span class="c1"># Manicure,50,60</span>
<span class="c1"># Pedicure,70,90</span>

<span class="s2">"./lib/data.csv"</span>
<span class="o">|&gt;</span> <span class="no">File</span><span class="o">.</span><span class="n">stream!</span><span class="p">()</span>
<span class="o">|&gt;</span> <span class="no">CSV</span><span class="o">.</span><span class="n">decode!</span><span class="p">(</span><span class="ss">headers:</span> <span class="no">true</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span> <span class="n">row</span> <span class="o">-&gt;</span>
  <span class="p">{</span>
    <span class="n">row</span><span class="p">[</span><span class="s2">"service_name"</span><span class="p">],</span>
    <span class="n">row</span><span class="p">[</span><span class="s2">"duration"</span><span class="p">],</span>
    <span class="n">row</span><span class="p">[</span><span class="s2">"base_price"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="k">end</span><span class="p">)</span>
</pre></table></code></div></div><p>When run, this script outputs a list of tuples shown below.</p><div class="language-elixir highlighter-rouge"><div class="code-header"> <span label-text="Elixir"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">[</span>
  <span class="p">{</span><span class="s2">"Haircut"</span><span class="p">,</span> <span class="s2">"30"</span><span class="p">,</span> <span class="s2">"50"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"Manicure"</span><span class="p">,</span> <span class="s2">"60"</span><span class="p">,</span> <span class="s2">"50"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"Pedicure"</span><span class="p">,</span> <span class="s2">"90"</span><span class="p">,</span> <span class="s2">"70"</span><span class="p">}</span>
<span class="p">]</span>
</pre></table></code></div></div><p>You would then take the list above and put it inside one of the functions, which would be used at runtime on production for whatever logic and the final module would look something like this.</p><div class="language-elixir highlighter-rouge"><div class="code-header"> <span label-text="Elixir"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">Playground</span> <span class="k">do</span>
  <span class="c1"># Script to use whenever necessary to</span>
  <span class="c1"># generate the body of some_important_function/0</span>
  <span class="c1">#</span>
  <span class="c1"># "/path/to/csv"</span>
  <span class="c1"># |&gt; File.stream!()</span>
  <span class="c1"># |&gt; CSV.decode!(headers: true)</span>
  <span class="c1"># |&gt; Enum.map(fn row -&gt;</span>
  <span class="c1">#   {</span>
  <span class="c1">#     row["service_name"],</span>
  <span class="c1">#     row["duration"],</span>
  <span class="c1">#     row["base_price"]</span>
  <span class="c1">#   }</span>
  <span class="c1"># end)</span>

  <span class="k">def</span> <span class="n">some_important_function</span> <span class="k">do</span>
    <span class="p">[</span>
      <span class="p">{</span><span class="s2">"Haircut"</span><span class="p">,</span> <span class="s2">"30"</span><span class="p">,</span> <span class="s2">"50"</span><span class="p">},</span>
      <span class="p">{</span><span class="s2">"Manicure"</span><span class="p">,</span> <span class="s2">"60"</span><span class="p">,</span> <span class="s2">"50"</span><span class="p">},</span>
      <span class="p">{</span><span class="s2">"Pedicure"</span><span class="p">,</span> <span class="s2">"90"</span><span class="p">,</span> <span class="s2">"70"</span><span class="p">}</span>
    <span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></table></code></div></div><p>Everything is fine so far, except that you have to run the script manually every time the CSV file changes. It works anyway. The problem started when we wanted to translate some of the strings from the CSV file, which means we would need to wrap some of the strings with <code class="language-plaintext highlighter-rouge">gettext/1</code> macro.</p><p>So the outcome we want to achieve is to have <code class="language-plaintext highlighter-rouge">some_important_function</code> as</p><div class="language-elixir highlighter-rouge"><div class="code-header"> <span label-text="Elixir"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="n">some_important_function</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="p">{</span><span class="n">gettext</span><span class="p">(</span><span class="s2">"Haircut"</span><span class="p">),</span> <span class="s2">"30"</span><span class="p">,</span> <span class="s2">"50"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">gettext</span><span class="p">(</span><span class="s2">"Manicure"</span><span class="p">),</span> <span class="s2">"60"</span><span class="p">,</span> <span class="s2">"50"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">gettext</span><span class="p">(</span><span class="s2">"Pedicure"</span><span class="p">),</span> <span class="s2">"90"</span><span class="p">,</span> <span class="s2">"70"</span><span class="p">}</span>
  <span class="p">]</span>
<span class="k">end</span>
</pre></table></code></div></div><p>We can‚Äôt directly wrap our strings with <code class="language-plaintext highlighter-rouge">gettext/1</code> in our ‚Äúscript‚Äù above because,</p><ol><li>The strings are not known at compile time, hence can‚Äôt be used with macros.<li>Moreover, it‚Äôs just a script and it‚Äôs not actually on production.</ol><p>One solution would be to manually wrap the necessary strings with <code class="language-plaintext highlighter-rouge">gettext/1</code> inside <code class="language-plaintext highlighter-rouge">some_important_function/0</code> above. But that‚Äôs too much manual work and error prone.</p><h2 id="solving-the-problem-at-compile-time-with-elixir-ast">Solving the problem at compile time with Elixir AST<a href="#solving-the-problem-at-compile-time-with-elixir-ast"><i class="fas fa-hashtag"></i></a></h2></h2><p>Doing some research and asking around in <a href="https://elixir-slackin.herokuapp.com/">Elixir Slack</a> (shout out to @lostkobrakai), I figured we could solve the problem using Elixir AST.</p><blockquote><p>What is the AST?</p><p>An AST, acronym for Abstact Syntax Tree, is a representation of code as a data structure. This data structure is used by Elixir to run Elixir code: either by interpreting it directly: executing the commands in the AST by recursively walking it; or by compiling it: translating the AST into another format, namely BEAM bytecode instructions, which then are saved to disk as .beam files.<sup><a href="https://www.botsquad.com/2019/04/11/the-ast-explained/">source: botsquad</a></sup></p></blockquote><p>We will first read the CSV at compile time and create the tuple list, which will then be used to create an AST with <code class="language-plaintext highlighter-rouge">gettext/1</code> macro used wherever necessary. Lastly we will <code class="language-plaintext highlighter-rouge">unquote/1</code> this AST within our actual function body which will be used at runtime on production. Moreover, we will use <a href="https://hexdocs.pm/elixir/main/Module.html#module-external_resource"><code class="language-plaintext highlighter-rouge">@external_resource</code></a> module attribute to make sure that whenever our CSV file changes our module will be recompiled, meaning that our code will always be up to date! No more running scripts manually. üéâ</p><blockquote><p><code class="language-plaintext highlighter-rouge">@external_resource</code></p><p>Tools may use this information to ensure the module is recompiled in case any of the external resources change, see for example: mix compile.elixir. <sup><a href="https://hexdocs.pm/elixir/main/Module.html#module-external_resource">source: Hexdocs</a></sup></p></blockquote><div class="language-elixir highlighter-rouge"><div class="code-header"> <span label-text="Elixir"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre><td class="rouge-code"><pre><span class="k">defmodule</span> <span class="no">Playground</span> <span class="k">do</span>
  <span class="c1"># This way our module will be recompiled whenever</span>
  <span class="c1"># you make changes to the CSV file.</span>
  <span class="c1"># Make some changes to the CSV file and recompile to see it in action.</span>
  <span class="nv">@external_resource</span> <span class="s2">"./lib/foo.csv"</span>

	<span class="c1"># Nothing fancy here, we're just creating a list of tuples</span>
  <span class="n">data</span> <span class="o">=</span>
    <span class="nv">@external_resource</span>
    <span class="o">|&gt;</span> <span class="no">File</span><span class="o">.</span><span class="n">stream!</span><span class="p">()</span>
    <span class="o">|&gt;</span> <span class="no">CSV</span><span class="o">.</span><span class="n">decode!</span><span class="p">(</span><span class="ss">headers:</span> <span class="no">true</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span> <span class="n">row</span> <span class="o">-&gt;</span>
      <span class="p">{</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"service_name"</span><span class="p">],</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"duration"</span><span class="p">],</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"base_price"</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="k">end</span><span class="p">)</span>

  <span class="no">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="c1"># =&gt;</span>
  <span class="c1"># [</span>
  <span class="c1">#   {"Haircut", "30", "50"},</span>
  <span class="c1">#   {"Manicure", "60", "50"},</span>
  <span class="c1">#   {"Pedicure", "90", "70"}</span>
  <span class="c1"># ]</span>

  <span class="c1"># This is where we build the AST.</span>
  <span class="n">data_ast</span> <span class="o">=</span>
    <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">fn</span> <span class="n">tuple</span> <span class="o">-&gt;</span>
      <span class="n">list</span> <span class="o">=</span>
        <span class="n">tuple</span>
        <span class="o">|&gt;</span> <span class="n">put_elem</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="ss">:gettext</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="n">elem</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]})</span>
        <span class="o">|&gt;</span> <span class="no">Tuple</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

      <span class="p">{:{},</span> <span class="p">[],</span> <span class="n">list</span><span class="p">}</span>
    <span class="k">end</span><span class="p">)</span>

  <span class="no">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">data_ast</span><span class="p">)</span>
  <span class="c1"># =&gt;</span>
  <span class="c1"># [</span>
  <span class="c1">#   {:{}, [], [{:gettext, [], ["Haircut"]}, "30", "50"]},</span>
  <span class="c1">#   {:{}, [], [{:gettext, [], ["Manicure"]}, "60", "50"]},</span>
  <span class="c1">#   {:{}, [], [{:gettext, [], ["Pedicure"]}, "90", "70"]}</span>
  <span class="c1"># ]</span>

  <span class="n">data_ast</span>
  <span class="o">|&gt;</span> <span class="no">Macro</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
  <span class="o">|&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">()</span>
  <span class="c1"># =&gt;</span>
  <span class="c1"># [</span>
  <span class="c1">#   {gettext("Haircut"), "30", "50"},</span>
  <span class="c1">#   {gettext("Manicure"), "60", "50"},</span>
  <span class="c1">#   {gettext("Pedicure"), "90", "70"}</span>
  <span class="c1"># ]</span>

  <span class="c1"># Now, this function would return the same thing</span>
  <span class="c1"># that's returned by Macro.to_string/1 above</span>
  <span class="k">def</span> <span class="n">some_important_function</span> <span class="k">do</span>
    <span class="kn">unquote</span><span class="p">(</span><span class="n">data_ast</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/til/'>TIL</a>, <a href='/categories/elixir/'>Elixir</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/elixir/" class="post-tag no-text-decoration" >elixir</a> <a href="/tags/elixir-ast/" class="post-tag no-text-decoration" >elixir-ast</a> <a href="/tags/abstract-syntax-tree/" class="post-tag no-text-decoration" >abstract-syntax-tree</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Creating a function with inputs from a file at compile time using Elixir AST - Burak Kaymakci&url=https://blog.burakaymakci.com/posts/creating-a-function-with-inputs-from-a-file-at-compile-time-using-elixir-ast/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Creating a function with inputs from a file at compile time using Elixir AST - Burak Kaymakci&u=https://blog.burakaymakci.com/posts/creating-a-function-with-inputs-from-a-file-at-compile-time-using-elixir-ast/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Creating a function with inputs from a file at compile time using Elixir AST - Burak Kaymakci&url=https://blog.burakaymakci.com/posts/creating-a-function-with-inputs-from-a-file-at-compile-time-using-elixir-ast/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/creating-a-function-with-inputs-from-a-file-at-compile-time-using-elixir-ast/">Creating a function with inputs from a file at compile time using Elixir AST</a><li><a href="/posts/how-do-supervisors-not-crash-when-linked-process-crashes/">How do supervisors not crash when one of the children processes crashes</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/elixir/">elixir</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/matlab/">matlab</a> <a class="post-tag" href="/tags/octave/">octave</a> <a class="post-tag" href="/tags/websockets/">websockets</a> <a class="post-tag" href="/tags/abstract-syntax-tree/">abstract-syntax-tree</a> <a class="post-tag" href="/tags/agent/">agent</a> <a class="post-tag" href="/tags/arduino/">arduino</a> <a class="post-tag" href="/tags/bootstrap/">bootstrap</a> <a class="post-tag" href="/tags/c/">c</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/elixir-operators/"><div class="card-body"> <em class="timeago small" date="2021-05-04 00:00:00 +0200" >May 4, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Elixir boolean operators</h3><div class="text-muted small"><p> There‚Äôs subtle difference between Elixir boolean operators. Namely between or and ||, and and &amp;amp;&amp;amp;, not and !. These operators expect true or false as their first argument: a or b # true if ...</p></div></div></a></div><div class="card"> <a href="/posts/programming-phoenix-how-does-websocket-work-only-on-video-page/"><div class="card-body"> <em class="timeago small" date="2021-05-19 00:00:00 +0200" >May 19, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Programming Phoenix 1.4 | How do the websockets connect only on the video page</h3><div class="text-muted small"><p> In the book Programming Phoenix 1.4, we are creating a web application where users can annotate YouTube videos and annotations get brodcast by WebSockets to all the users that are on the same video...</p></div></div></a></div><div class="card"> <a href="/posts/how-does-ecto-infer-field-type-from-a-changeset-or-a-schema-struct/"><div class="card-body"> <em class="timeago small" date="2021-07-16 00:00:00 +0200" >Jul 16, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How Ecto infers field types from a changeset or a schema struct</h3><div class="text-muted small"><p> I was wondering how Ecto.Changeset.cast/4 function casts attributes from a map into their approriate types in the DB since we do not provide any information about the types explicitly. Turns out t...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/how-do-supervisors-not-crash-when-linked-process-crashes/" class="btn btn-outline-primary" prompt="Older"><p>How do supervisors not crash when one of the children processes crashes</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> ¬© 2022 <a href="https://twitter.com/andreyuhai">Burak Kaymakci</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/elixir/">elixir</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/matlab/">matlab</a> <a class="post-tag" href="/tags/octave/">octave</a> <a class="post-tag" href="/tags/websockets/">websockets</a> <a class="post-tag" href="/tags/abstract-syntax-tree/">abstract-syntax-tree</a> <a class="post-tag" href="/tags/agent/">agent</a> <a class="post-tag" href="/tags/arduino/">arduino</a> <a class="post-tag" href="/tags/bootstrap/">bootstrap</a> <a class="post-tag" href="/tags/c/">c</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-7JNCCP2ZJ3"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-7JNCCP2ZJ3'); }); </script>
